// This module is included in the following assemblies:
// * secure/setting-up-openshift-pipelines-to-view-software-supply-chain-security-elements.adoc

:_mod-docs-content-type: PROCEDURE
[id="op-setting-up-openshift-pipelines-to-view-project-vulnerabilities_{context}"]
= Setting up {pipelines-shortname} to view project vulnerabilities 

The PipelineRun details page provides a visual representation of identified vulnerabilities,  categorized by the severity (critical, high, medium, and low). This streamlined view facilitates prioritization and remediation efforts.

.Viewing vulnerabilities on the `PipelineRun` details page
image::vulnerabilities_details.png[]

You can also review the vulnerabilities in the *Vulnerabilities* column in the pipeline run list view page.

.Viewing vulnerabilities on the `PipelineRun` list view
image::vulnerabilities_list.png[]

[NOTE]
====
Visual representation of identified vulnerabilities is available starting from the Openshift 4.15 release.
====

.Prerequisites

* You have link:https://docs.openshift.com/container-platform/4.14/web_console/web-console.html#web-console[logged in to the web console].

* You have the appropriate link:https://docs.openshift.com/container-platform/4.14/authentication/using-rbac.html#default-roles_using-rbac[roles and permissions] in a project to create applications and other workloads in OpenShift Container Platform.

* You have an existing vulnerability scan task.

.Procedures

. In the *Developer* or *Administrator* perspective, switch to the relevant project where you want a visual representation of vulnerabilities.

. Update your existing vulnerability scan task to ensure that it stores the output in the .json file and then extracts the vulnerability summary in the following format:

+
[source,yaml]
----
# The format to extract vulnerability summary (adjust the jq command for different JSON structures).
jq -rce \ 
    '{vulnerabilities:{
      critical: (.result.summary.CRITICAL),
      high: (.result.summary.IMPORTANT),
      medium: (.result.summary.MODERATE),
      low: (.result.summary.LOW)
      }}' scan_output.json | tee $(results.SCAN_OUTPUT.path)

----
+
[NOTE]
====
You might need to adjust the link:https://jqlang.github.io/jq/download/[jq] command for different JSON structures.
====

.. (Optional) If you do not have a vulnerability scan task, create one in the following format:
+
*Example vulnerability scan task using Roxctl*
+
[source,yaml]
----
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: vulnerability-scan  # <1>
  annotations:
    task.output.location: results  # <2>
    task.results.format: application/json
    task.results.key: SCAN_OUTPUT  # <3>
spec:
  results:
    - description: CVE result format  # <4>
      name: SCAN_OUTPUT
      value: string
  steps:
    - name: roxctl  # <5>
      image: quay.io/roxctl-tool-image  # <6>
      env:
        - name: ENV_VAR_NAME_1  # <7>
          valueFrom:
            secretKeyRef:
              key: secret_key_1            
              name: secret_name_1
      env:
        - name: ENV_VAR_NAME_2
          valueFrom:
            secretKeyRef:
              key: secret_key_2            
              name: secret_name_2
      script: | # <8>
        #!/bin/sh
        
        # Sample shell script

        echo "ENV_VAR_NAME_1: " $ENV_VAR_NAME_1
        echo "ENV_VAR_NAME_2: " $ENV_VAR_NAME_2
        jq --version (adjust the jq command for different JSON structures)
        curl -k -L -H "Authorization: Bearer $ENV_VAR_NAME_1" https://$ENV_VAR_NAME_2/api/cli/download/roxctl-linux --output ./roxctl
        chmod +x ./roxctl 
        echo "roxctl version"
        ./roxctl version
        echo "image from pipeline: " 
        
        # Replace the following line with your dynamic image logic
        DYNAMIC_IMAGE=$(get_dynamic_image_logic_here)
        echo "Dynamic image: $DYNAMIC_IMAGE"
        ./roxctl image scan --insecure-skip-tls-verify -e $ENV_VAR_NAME_2 --image $DYNAMIC_IMAGE --output json  > roxctl_output.json
        more roxctl_output.json
        jq -rce \  # <9>
          '{vulnerabilities:{
          critical: (.result.summary.CRITICAL),
          high: (.result.summary.IMPORTANT),
          medium: (.result.summary.MODERATE),
          low: (.result.summary.LOW)
            }}' scan_output.json | tee $(results.SCAN_OUTPUT.path)
----
<1> The name of your task.
<2> The location for storing the task outputs.
<3> The naming convention of the scan task result. A valid naming convention must end with the `SCAN_OUTPUT` string. For example, SCAN_OUTPUT, MY_CUSTOM_SCAN_OUTPUT, or ACS_SCAN_OUTPUT.
<4> The description of the result.
<5> The name of the vulnerability scanning tool that you have used. 
<6> The location of the actual image containing the scan tool.
<7> The tool-specific environment variables.
<8> The shell script to be executed with json output. For example, scan_output.json.
<9> The format to extract vulnerability summary (adjust `jq` command for different JSON structures).
+
[NOTE]
====
This is just an example configuration. Modify the values according to your specific scanning tool to set results in the expected format.
====

. Update an appropriate Pipeline to add vulnerabilities specifications in the following format:

+
[source,yaml]
----
...
spec:
  results:
    - description: The common vulnerabilities and exposures (CVE) result
      name: SCAN_OUTPUT
      value: $(tasks.vulnerability-scan.results.SCAN_OUTPUT)
----

.Verification

* Navigate to the `PipelineRun` details page and review the *Vulnerabilities* row for a visual representation of identified vulnerabilities.

* Alternatively, you can navigate to the `PipelineRun` list view page, and review the *Vulnerabilities* column.
